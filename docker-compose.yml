services:
  # --- BioDockify MAIN APP ---
  app:
    build: . # Local build ensures 2.3.7 fixes (static paths + 3000) are applied
    container_name: biodockify-app
    ports:
      - "3000:3000"
    extra_hosts:
      - "host.docker.internal:host-gateway" # Access LM Studio on host
    environment:
      - PORT=3000
      # Database Config
      - GRAPH_DB_TYPE=neo4j
      - NEO4J_URI=bolt://neo4j:7687
      - NEO4J_USER=neo4j
      - NEO4J_PASSWORD=biodockify2024
      # AI Config (LM Studio connection)
      - LM_STUDIO_URL=http://host.docker.internal:1234/v1
      # Services
      - GROBID_URL=http://grobid:8070
    depends_on:
      neo4j:
        condition: service_healthy
      grobid:
        condition: service_started
    volumes:
      - biodockify-data:/app/data
    networks:
      - biodockify-network
    restart: unless-stopped

  # --- SUPPORTING SERVICES ---

  # Neo4j Graph Database
  neo4j:
    image: neo4j:latest
    container_name: biodockify-neo4j
    ports:
      - "7474:7474"
      - "7687:7687"
    environment:
      - NEO4J_AUTH=neo4j/biodockify2024
      - NEO4J_PLUGINS=["graph-data-science", "apoc"]
      - NEO4J_dbms_memory_heap_initial__size=512m
      - NEO4J_dbms_memory_heap_max__size=1G
    volumes:
      - neo4j-data:/data
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider localhost:7474 || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 40s
    networks:
      - biodockify-network
    restart: unless-stopped

  # GROBID PDF Parser
  grobid:
    image: lfoppiano/grobid:0.8.0
    container_name: biodockify-grobid
    ports:
      - "8070:8070"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8070/api/isalive"]
      interval: 30s
      timeout: 10s
      retries: 10
      start_period: 120s
    networks:
      - biodockify-network
    restart: unless-stopped

volumes:
  biodockify-data:
  neo4j-data:

networks:
  biodockify-network:
    driver: bridge
