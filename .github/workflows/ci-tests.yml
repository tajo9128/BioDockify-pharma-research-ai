name: BioDockify CI

on:
  push:
    branches: [ "main", "development" ]
  pull_request:
    branches: [ "main", "development" ]

jobs:
  test-backend:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3
      with:
        submodules: recursive

    - name: Set up Python 3.9
      uses: actions/setup-python@v4
      with:
        python-version: "3.10"

    - name: Install Dependencies
      run: |
        python -m pip install --upgrade pip
        # Install CPU-only Torch to save massive disk space (avoids 3GB+ CUDA libs)
        pip install torch torchvision torchaudio --index-url https://download.pytorch.org/whl/cpu
        # Install CPU-only TensorFlow where possible (Linux only usually, but good practice)
        pip install tensorflow-cpu==2.15.0 || pip install tensorflow==2.15.0
        # Check root or api directory for requirements
        if [ -f "requirements.txt" ]; then
          pip install -r requirements.txt
        elif [ -f "api/requirements.txt" ]; then
          pip install -r api/requirements.txt
        else
          echo "Warning: requirements.txt not found in root or api/"
        fi
        pip install pytest pytest-asyncio httpx requests psutil fastapi uvicorn neo4j

    - name: Start Backend
      run: |
        python server.py &
        echo "Waiting for backend to start..."
        # Wait up to 60 seconds for port 8234 to be active
        timeout 60s bash -c 'until curl -sf http://localhost:8234/api/health > /dev/null 2>&1; do sleep 2; done' || (echo "Backend failed to start" && exit 1)
        echo "Backend is ready!"

    - name: Run Backend Tests
      run: |
        # Only run if tests exist
        if [ -d "tests" ]; then
          export PYTHONPATH=$PYTHONPATH:.
          pytest tests/
        else
          echo "No tests directory found, skipping"
        fi

  test-frontend:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./ui
    steps:
    - uses: actions/checkout@v3

    - name: Set up Node.js
      uses: actions/setup-node@v3
      with:
        node-version: 18

    - name: Install Dependencies
      run: npm install

    - name: Run Linter
      run: npm run lint
      continue-on-error: true # Warning for now until all lints fixed

    # - name: Run Unit Tests
    #   run: npm test
